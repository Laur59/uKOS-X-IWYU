From b1a60089aee55585ea70a4d26e0f614c63450589 Mon Sep 17 00:00:00 2001
From: Laur59 <148864407+Laur59@users.noreply.github.com>
Date: Mon, 23 Jun 2025 18:57:51 +0300
Subject: [PATCH 1/3] Adapt CMake configuration to needs for uKOS-X

Use the runtimes project to build compiler-rt
---
 arm-software/embedded/CMakeLists.txt            |  8 +++++---
 .../embedded/arm-runtimes/CMakeLists.txt        | 17 ++++++++++++-----
 2 files changed, 17 insertions(+), 8 deletions(-)

diff --git a/arm-software/embedded/CMakeLists.txt b/arm-software/embedded/CMakeLists.txt
index 8f395ac6c7a1..f45f6b8b1f42 100644
--- a/arm-software/embedded/CMakeLists.txt
+++ b/arm-software/embedded/CMakeLists.txt
@@ -151,7 +151,7 @@ set(PARALLEL_LIB_BUILD_LEVELS
 option(
     ENABLE_QEMU_TESTING
     "Enable tests that use QEMU. This option is ON by default."
-    ON
+    OFF
 )
 option(
     ENABLE_FVP_TESTING
@@ -210,6 +210,7 @@ set(LLVM_DISTRIBUTION_COMPONENTS
     llvm-cov
     llvm-cxxfilt
     llvm-dwarfdump
+    llvm-mc
     llvm-nm
     llvm-objcopy
     llvm-objdump
@@ -221,6 +222,7 @@ set(LLVM_DISTRIBUTION_COMPONENTS
     llvm-strings
     llvm-strip
     llvm-symbolizer
+    scan-build
     LTO
     CACHE STRING ""
 )
@@ -234,8 +236,8 @@ set(LLVM_TOOLCHAIN_DISTRIBUTION_COMPONENTS
 installed by the install-llvm-toolchain target"
 )
 set(LLVM_ENABLE_PROJECTS clang;lld CACHE STRING "")
-set(LLVM_TARGETS_TO_BUILD AArch64;ARM CACHE STRING "")
-set(LLVM_DEFAULT_TARGET_TRIPLE aarch64-linux-gnu CACHE STRING "")
+set(LLVM_TARGETS_TO_BUILD ARM CACHE STRING "")
+set(LLVM_DEFAULT_TARGET_TRIPLE arm-none-eabi CACHE STRING "")
 set(LLVM_APPEND_VC_REV OFF CACHE BOOL "")
 set(LLVM_ENABLE_TERMINFO OFF CACHE BOOL "")
 set(LLVM_ENABLE_ZLIB OFF CACHE BOOL "")
diff --git a/arm-software/embedded/arm-runtimes/CMakeLists.txt b/arm-software/embedded/arm-runtimes/CMakeLists.txt
index 61d19bd7349f..00fb7a2b7371 100644
--- a/arm-software/embedded/arm-runtimes/CMakeLists.txt
+++ b/arm-software/embedded/arm-runtimes/CMakeLists.txt
@@ -248,20 +248,23 @@ endif()
 
 if(ENABLE_COMPILER_RT_TESTS)
     set(compiler_rt_test_flags "${lib_compile_flags} ${test_link_flags}")
-    set(compiler_rt_lit_args "${LLVM_LIT_ARGS} --xunit-xml-output=results.junit.xml")
+    set(compiler_rt_lit_args "${LLVM_LIT_ARGS} --path=${LLVM_BINARY_DIR}/bin --xunit-xml-output=results.junit.xml")
+    set(external_lit_path "${LLVM_BINARY_DIR}/bin/llvm-lit")
     set(
         compiler_rt_test_cmake_args
         -DCOMPILER_RT_INCLUDE_TESTS=ON
         -DCOMPILER_RT_EMULATOR=${lit_test_executor}
         -DCOMPILER_RT_TEST_COMPILER=${LLVM_BINARY_DIR}/bin/clang
         -DCOMPILER_RT_TEST_COMPILER_CFLAGS=${compiler_rt_test_flags}
+        -DLLVM_INCLUDE_TESTS=OFF
         -DLLVM_LIT_ARGS=${compiler_rt_lit_args}
+        -DLLVM_EXTERNAL_LIT=${external_lit_path}
     )
 endif()
 
 ExternalProject_Add(
     compiler_rt
-    SOURCE_DIR ${llvmproject_src_dir}/compiler-rt
+    SOURCE_DIR ${llvmproject_src_dir}/runtimes
     STAMP_DIR ${PROJECT_PREFIX}/compiler_rt/${VARIANT_BUILD_ID}/stamp
     BINARY_DIR ${PROJECT_PREFIX}/compiler_rt/${VARIANT_BUILD_ID}/build
     DOWNLOAD_DIR ${PROJECT_PREFIX}/compiler_rt/${VARIANT_BUILD_ID}/dl
@@ -291,7 +294,8 @@ ExternalProject_Add(
     -DCOMPILER_RT_BUILD_SANITIZERS=OFF
     -DCOMPILER_RT_BUILD_XRAY=OFF
     -DCOMPILER_RT_DEFAULT_TARGET_ONLY=ON
-    -DLLVM_CMAKE_DIR=${LLVM_BINARY_DIR}
+    -DLLVM_ENABLE_RUNTIMES=compiler-rt
+    -DRUNTIME_VARIANT_NAME=${VARIANT}
     -DLLVM_ENABLE_PER_TARGET_RUNTIME_DIR=ON
     ${compiler_rt_test_cmake_args}
     STEP_TARGETS configure build install
@@ -385,6 +389,7 @@ if(C_LIBRARY STREQUAL picolibc)
 
     configure_file(${CMAKE_CURRENT_SOURCE_DIR}/meson-cross-build.txt.in ${CMAKE_CURRENT_BINARY_DIR}/meson-cross-build.txt @ONLY)
 
+    set(PICOLIBC_OPTIONS -Dmultilib=false -Dio-c99-formats=true -Dio-long-long=true -Dpicolib=true -Dnewlib-multithread=true -Dposix-io=true -Dpicocrt=false -Dpicocrt-lib=false -Dtests=false)
     ExternalProject_Add(
         picolibc
         STAMP_DIR ${PROJECT_PREFIX}/picolibc/${VARIANT_BUILD_ID}/stamp
@@ -400,6 +405,7 @@ if(C_LIBRARY STREQUAL picolibc)
             -Dincludedir=include
             -Dlibdir=lib
             -Dspecsdir=none
+            ${PICOLIBC_OPTIONS}
             -Dmultilib=false
             -Ddebug=false
             -Dtests-enable-stack-protector=false
@@ -520,9 +526,10 @@ if(C_LIBRARY MATCHES "^newlib")
             --disable-nls
             --enable-lite-exit
             --disable-multilib
-            --enable-newlib-retargetable-locking)
+            --enable-newlib-retargetable-locking
+            --enable-newlib-io-float)
         set(newlib_optim_flags
-            "-g -O2")
+            "-Os")
     endif()
 
     include(${TOOLCHAIN_SOURCE_DIR}/cmake/fetch_newlib.cmake)
-- 
2.39.5 (Apple Git-154)

